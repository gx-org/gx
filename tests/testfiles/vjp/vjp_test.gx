package vjp

import (
	"math"
	"math/grad"
)

func F(x float32) float32 {
	return math.Sin[float32](x)
}

func TestVJPF() func(x float32) (float32, func(res float32) float32) {
	return grad.VJP(F)
	// Want:
	// func(x float32) (float32, func(res float32) float32) {
	// 	fwd0, SinVJP := grad.VJP(math.Sin)[float32](x)
	// 	selfVJPFunc := func(res float32) float32 {
	// 		bck0 := SinVJP(res)
	// 		return bck0
	// 	}
	// 	return fwd0, selfVJPFunc
	// }
}

func SoftMax(x float32) float32 {
	return 1 / (1 + math.Exp(-x))
}

func TestVJPSoftMax() (float32, float32) {
	vjp := grad.VJP(SoftMax)
	trace(vjp)
	y, bck := vjp(0.8)
	return y, bck(1)
	// Want:
	// 0: float32(0.689974)
	// 1: float32(0.21391)
	// Trace:
	// vjp_test.gx:0
	// 	func(x float32) (float32, func(res float32) float32) {
	// 		fwd0 := -x
	// 		fwd1, ExpVJP := grad.VJP(math.Exp)[float32](fwd0)
	// 		fwd2 := 1+fwd1
	// 		fwd3 := 1/fwd2
	// 		selfVJPFunc := func(res float32) float32 {
	// 			bck3x := res/fwd2
	// 			bck3y := -res/(fwd2*fwd2)
	// 			bck1 := ExpVJP(bck3y)
	// 			bck0 := -bck1
	// 			return bck0
	// 		}
	// 		return fwd3, selfVJPFunc
	// 	}
}

func f1(x float32) float32 {
	return x * x
}

func TestF1() (float32, float32) {
	y, bck := grad.VJP(f1)(3)
	return y, bck(1)
	// Want:
	// 0: float32(9)
	// 1: float32(6)
}

func f2(x float32) float32 {
	a := x
	x = 2
	return a * x // 2*x
}

func TestF2() (float32, float32) {
	y, bck := grad.VJP(f2)(3)
	return y, bck(1)
	// Want:
	// 0: float32(6)
	// 1: float32(2)
}

func f3(x float32) float32 {
	a := x
	x = 2 * x
	return a * x // 2*x*x
}

func TestF3() (float32, float32) {
	y, bck := grad.VJP(f3)(3)
	return y, bck(1)
	// Want:
	// 0: float32(18)
	// 1: float32(12)
}

func arrayLiteral(x float32) [3][2]float32 {
	return [3][2]float32{
		{1 * x, 2 * x},
		{3 * x, 4 * x},
		{5 * x, 6 * x},
	}
}

func TestArrayLiteral() ([3][2]float32, float32) {
	y, bck := grad.VJP(arrayLiteral)(2)
	return y, bck([3][2]float32(1))
	// Want:
	// 0: [3][2]float32{
	// 	{2, 4},
	// 	{6, 8},
	// 	{10, 12},
	// }
	// 1: float32(21)
}

